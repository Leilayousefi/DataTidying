---
title: "Data Tidying"
output: Tidy Dataset
---

This is an [R Markdown](http://garrettgman.github.io/tidying/) Notebook. ‚Äútidy data,‚Äù a way to organize your data that works particularly well with R. 
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.



## Package Creatation
```{r}

# Loading required package: 
install.packages("usethis")
install.packages(c("devtools", "roxygen2", "testthat", "tidyverse", "knitr", "tidyr", "dplyr", "ggplot2", "stringr"))

#devtools::install_github("tidyverse/forcats")
devtools::install_github("garrettgman/DSR",force = TRUE)
library(usethis)
library(devtools)
library(roxygen2)
library(testthat)
library(tidyverse)
library(tidyr)
library(DSR)
library(dplyr)
library(ggplot2)
library(knitr)
library(stringr)

# version of devtools?
# packageVersion("devtools")
# devtools::session_info()


```

## ----------------------------------------------- ##
##   Package Development Prerequisites  ##
https://support.rstudio.com/hc/en-us/articles/200486498-Package-Development-Prerequisites?_ga=2.234745885.203624782.1644777422-446760655.1643130254


```{r}
getwd()
setwd("~/git/MoJ/TidyData/DataTidying")

devtools::create("/Users/leilayousefi/LeilaDocuments/git/MoJ/TidyData/DataTidying")
```

## ----------------------------------------------- ##
```{r}
getwd()

#' GOV.UK register register.
#'
#' A dataset containing the characteristics of all
#'  the published GOV.UK registers.
#'
#' @format A data frame
#' \describe{
#'   \item{date}{date register was published}
#'   \item{register}{name of register}
#'   \item{text}{description of register contents}
#'   \item{registry}{responsible body of register}
#'   \item{phase}{The stage of development a register is in.
#'   There are 4 phases - discovery, alpha, beta and live.}
#'   \item{copyright}{The copyright and licensing terms which
#'    may apply to the data held in a register.}
#'   \item{fields}{variables contained in the register}
#'   ...
#' }
#' @source \url{https://register.register.gov.uk/records}
"regreg"

```


## Git Repo
cd DataTidying 

# Check where were you to start from the previous steps
git log --oneline 

git status 
git add . -n
git add .
git commit -m "created package in R" 
git status 
git push



## Create new issue in github:
# name the issue: Add sensitive file to gitignore

git status
git branch
git pull

git branch fix/3
git checkout fix/3
(git checkout -b fix/3)

vim sensitive.txt

cmd(ctrl)+i
secrets

before and wish to exit a session without saving your changes, press Esc then type :q! and hit Enter or ‚Üµ or on Macs, Return . If you want to save your changes and quit, press Esc then type :wq and hit Enter or ‚Üµ or on Macs, Return .

ESC
:wq #(for saving the changes and file)
:q! 

ls -a
git status
git add . -n
git add .
git commit -m "Added sensitive file in gitignore"

ls -a
vim .gitignore
add sensitive.txt to it 
ESC
:wq

(or add the sensitive.txt through Rstadio)

git push origin fix/3 -u
git push


## goto github:
compare and pull request
Add reviewers and assignee
after their review 
merge
confirm

==> you cannot see sensitive.txt on the cloud github

## look at https://github.com/ukgovdatascience/dotfiles for more information on sensitive files and implement it on your system for the privacy of sensitive information before get push on Github and the cloud
Often you will work on projects with sensitive data or analyses; you need a way to prevent these files from being published on Github. Fortunately, you can do this using .gitignore as well as other advanced tools like githooks.

Type git status in the command line.

Now add SECRET.*  to .gitignore 

Type git status  again.

What happens?

Questions for this assignment
How could you use your .gitignore file to protect yourself against accidentally committing sensitive data? Do you have a boiler plate .gitignore template to use?

git clone https://github.com/ukgovdatascience/dotfiles
cd dotfiles

## Copy the file into the root of a git repository and edit as approproate.

## Set as .gitignore_global
To use for ALL git repos, the template can be set globally. Note that this is likely to be very annoying in its current form, so should be edited as appropriate, otherwise trivial files are likely to be invisible to git. Even ignored files can be added with git add -f, however you need to realise that they are being ignored!

cp .gitignore ~/.gitignore_global
git config --global core.excludesfile ~/.gitignore_global

## set this as the .gitignore_global, you can exclude individual repositories by running:

git config --local --unset core.excludesfile

## The above can be used with --global to stop using it as the global .gitignore.

More information about ignoring files can be found here: https://help.github.com/articles/ignoring-files/


pre-commit and pre-push hooks
These hooks will check, at the point of each commit and push, that the the code does not contain any of the following:

AWS keys (determined by regex)
Private SSH keys (determined by regex)
.pem files
Various data formats:
xls, xlsx, xlsm, xlst,
csv, txt,
sav,
db, sqlite,
feather, pkl, pickle,
ods, gsheet,
Rdata, Rds
ipython/jupyer notebooks (ipynb)
Install in all new repositories
** Note that this will overwrite any prior pre-commit and pre-push hooks you may have already installed**

cp -r git_template ~/.git_template

git config --global init.templatedir '~/.git_template'

## Install into any pre-existing repositories
Having done the previous step, run the following to sync git hooks with the defaults in ~/.git_template:

$(git config --path --get init.templatedir)/update.sh
Install all pre-existing repositories in a directory
The following code will cycle through all directories in a folder (assuming they are all managed by git), and install the default hooks into each of them:

current=$(pwd); for i in $(ls .); do echo $i; cd $i ; $(git config --path --get init.templatedir)/update.sh; cd $current done

## ..................................##
## Create an Object from raw data

## create a new branch for data
create a new directory (raw-data)
add the csv file to it

git pull
cd data-raw 
ls -a

git status

git checkout -b feature/data
ls

git status

cd ../
ls

git status

git add . -n
git add .

## ----------------------------------------------- ##


## tidy data and clean it and then convert raw data to a nice R object of the minimal tidy data set.

This section introduces ‚Äútidy data,‚Äù a way to organize your data that works particularly well with R.

squashed your commits and pushed to Github and created a pull request for your RAP buddy to review


```{r}
#devtools::check()
regreg <- read.csv('./data-raw/register.csv', header = TRUE)

#regreg <- readr::read_csv("./data-raw/register.csv")
#devtools::use_data(regreg)
# some code to go from raw data csv to a nice RDA object


# create_regreg

regreg <- readr::read_csv("./data-raw/register.csv")

# as factor
regreg$phase <- forcats::as_factor(regreg$phase)

#give nice name
regreg <- dplyr::rename(regreg, date = `entry-timestamp`)

# copyright looks empty
regreg <- dplyr::select(regreg, -copyright)

# overwrite old data
usethis::use_data(regreg, overwrite = TRUE)

rm(regreg)
```

# Look at https://r-pkgs.org/data.html#data-extdata for more information

## ----------------------------------------------- ##


## Rendering development documentation

# Whenever you make a new changes and whant to see the effect of those changes in the pachage use:

cmd(ctrl) + Shift + L
==
devtools::load_all(".")

?regreg does not show anything ==>
in R folder create a new R code : data.R

cmd(ctrl) + Shift + D
==> 
devtools::document(roclets = c('rd', 'collate', 'namespace'))

Thus, see ?regreg that
shows Rendering development documentation for "regreg"

# Making Messy Data Pretty
# Logging When Things Go Wrong
https://www.r-bloggers.com/2016/08/python-style-logging-in-r/

https://www.r-bloggers.com/2013/03/better-logging-in-r-aka-futile-logger-1-3-0-released/

http://adv-r.had.co.nz/Exceptions-Debugging.html

```{r}
?regreg 

devtools::load_all(".")
devtools::document(roclets = c('rd', 'collate', 'namespace'))

?regreg 
rm(list = c("figure_2"))
```

## ---------------------------------------------- ##
## QUALITY ASSURRANCE ==> ERROR LOGGING DEBUGGING MESSAGING
## Converting the data object into minimal tidy dataset and class

# Use futile.logger

# Object Documentation:

see https://r-pkgs.org/man.html

Create a new function: phase_date_data.R
and place it in R folder

phase_date_data.R:
```{r}
devtools::load_all()
#' @title minimal tidy data set for DataTidying report production.
#'
#' @description \code{year_phase_data} is the class used for the creation of all
#'  figures and tables in the made up RAP report (it's a demo for the RAP MOOC).
#'
#'
#' @details The \code{year_phase_data} class expects a \code{data.frame} with at
#' least three columns: phase, date (entry-timestamp), and register name. Each
#' row represents a unique register.
#'
#'   Once inititated, the class has five slots: \code{df}: the basic
#'   \code{data.frame}, \code{colnames}: a character vector containing the
#'   column names from the \code{df}, \code{phase_levels}: a
#'   factor vector containing levels of \code{df$phase} of the factor sector,
#'   \code{yq}: an date vector containing \code{zoo::as.yearqrt(df$date)}.
#'
#' @param x Input dataframe, see details.
#' @param log_level The severity level at which log messages are written from
#' least to most serious: TRACE, DEBUG, INFO, WARN, ERROR, FATAL. Default is
#' level is INFO. See \code{?flog.threshold()} for additional details.
#' @param log_appender Defaults to write the log to "console", alternatively you
#' can provide a character string to specify a filename to also write to. See
#' for additional details \code{?futile.logger::appender.tee()}.
#' @param eda If TRUE an graphical data analysis is conducted for a human to check.
#'
#' @return If the class is not instantiated correctly, nothing is returned.
#'
#' @examples
#'
#' library(DataTidying)
#'
#' df <- phase_date_data(regreg)
#'
#' @export


phase_date_data <- function(x, log_level = futile.logger::WARN,
                             log_appender = "console", eda = FALSE) {

  # Set logger severity threshold, defaults to
  # high level use (only flags warnings and errors)
  # Set log_level argument to futile.logger::TRACE for full info
  futile.logger::flog.threshold(log_level)

  # Set where to write the log to
  if (log_appender != "console")
  {
    # if not console then to a file called...
    futile.logger::flog.appender(futile.logger::appender.file(log_appender))
  }

  # Checks
  futile.logger::flog.info('Initiating phase_date_data class.
                           \n\nExpects a data.frame with at
                           least three columns: phase, date (entry-timestamp),
                           and register name. Each
                           row represents a unique register..
                           More information on the format expected by
                           this class is given by ?phase_date_data().')

  # Integrity checks on incoming data ----

  # Check the structure of the data is as expected: data.frame containing no
  # missing values and at least three columns, containing phase, date and register name.

  futile.logger::flog.info('\n*** Running integrity checks on input dataframe (x):')
  futile.logger::flog.debug('\nChecking input is properly formatted...')

  futile.logger::flog.debug('Checking x is a data.frame...')
  if (!is.data.frame(x))
  {
    futile.logger::flog.error("x must be a data.frame",
                              x, capture = TRUE)
  }

  futile.logger::flog.debug('Checking x has correct columns...')
  if (length(colnames(x)) < 3)
  {
    futile.logger::flog.error("x must have at least three columns: phase, date and register")
  }

  futile.logger::flog.debug('Checking x contains a date column...')
  if (!'date' %in% colnames(x)) stop("x must contain date column")

  futile.logger::flog.debug('Checking x contains a phase column...')
  if (!'phase' %in% colnames(x)) stop("x must contain phase column")

  futile.logger::flog.debug('Checking x does not contain missing values...')
  if (anyNA(x)) stop("x cannot contain any missing values")

  futile.logger::flog.debug('Checking for the correct number of rows...')
  if (nrow(x) < 25) {
    futile.logger::flog.warn("x does not appear to be well formed. nrow(x) should be
                             greater than 26 as of early 2018.")
  }



  futile.logger::flog.info('...passed')

  # User assertr to run statistical tests on the data itself ----

  futile.logger::flog.info("\n***Running statistical checks on input dataframe (x)")

  futile.logger::flog.trace("These tests are implemented using the package assertr see:
                            https://cran.r-project.org/web/packages/assertr for more details.")


  # Check snsible range for year

  futile.logger::flog.debug('Checking years in a sensible range (2015:2025)...')

  if (any(lubridate::year(regreg$date) < 2016)) {
    futile.logger::flog.warn("The dates are not in a sensible range, have they been
                             read in correctly?")
  }

  # hopefully moved beyond RAP by 2025...
  if (any(lubridate::year(regreg$date) > 2025)) {
    futile.logger::flog.warn("The dates look dodgy,
                             are you still using RAP in 2025?")
  }

  # Check that the correct levels are in phase

  futile.logger::flog.debug('Checking sectors are correct...')

  # Save sectors name lookup for use later

  phase_set <- c(
    "discovery"    = "Discovery",
    "alpha"    = "Alpha",
    "beta"     = "Beta",
    "live"    = "Live"
  )

  # Check for outliers ----

  # Could check for outliers here... given our data we can't

  futile.logger::flog.info('...passed')

  # Reset threshold to package default
  futile.logger::flog.threshold(futile.logger::INFO)
  # Reset so that log is appended to console (the package default)
  futile.logger::flog.appender(futile.logger::appender.console())

  # Message required to pass a test
  message("Checks completed successfully:
          object of 'phase_date_data' class produced!")

  # EDA
  # some people like to eyeball stuff
  if (eda == TRUE) {
    plot(rev(regreg$date),
         ylab = "Date published",
         xlab = "Cumulative count of published registers")

  }

  # Drop unnecessary columns
  x <- x[, c("register", "phase", "date")]
  # Define the class here ----

  structure(
    list(
      df = x,
      colnames = colnames(x),
      type = colnames(x)[!colnames(x) %in% c('date','phase', 'register')],
      phase_levels = levels(x$phase),
      phase_set = phase_set,
      yq = zoo::as.yearqtr(x$date, format = "%Y-%m-%d")
    ),
    class = "phase_date_data")
}

```

rm(list = c("phase_date_data"))

==> devtools::load_all(".")
==> devtools::document(roclets = c('rd', 'collate', 'namespace'))

x <- DataTidying::phase_date_data(regreg, eda = TRUE)

Checks completed successfully:
          object of 'phase_date_data' class produced!

# 
          
class(x)
==>     [1] "phase_date_data"

```{r}
rm(list = c("phase_date_data"))

devtools::load_all(".")
devtools::document(roclets = c('rd', 'collate', 'namespace'))

x <- DataTidying::phase_date_data(regreg, eda = TRUE)

class(x)

figure_2 <- DataTidying::figure_2

```


```{r}

devtools::load_all(".")
devtools::document(roclets = c('rd', 'collate', 'namespace'))

```

## ----------------------------------------------- ##

## Create a new issue in Github
# Created fivereg_recent.R #6
a new issue --> name: Created fivereg_recent.R

## Writing Functions
Write a function.
Load it with Ctrl/Cmd + Shift + L or devtools::load_all().
Experiment with it in the console to see if it works.
Rinse and repeat.

fivereg_recent inside fivreg_recent.R file created in R folder

#Added fivreg_recent.R :

```{r}
devtools::load_all()
#' @title The five most recent published registers.
#'
#' @description The \code{fivereg_recent} function expects the
#'  \code{year_phase_data} and outputs a character string.
#'
#'
#' @details The registers are sorted by publication date and name by
#'  alphabetical order. The top five registers are output as a character string
#'  including commas and an and, for inclusion in the report.
#'
#' @param x Input object of \code{year_phase_data} class.
#' @param n The \code{n} passed to \code{head}.
#'
#' @return Returns a character string of the five most recent registers.
#'
#' @examples
#'
#' library(DataTidying)
#' report_data <- phase_date_data(regreg)
#' fivereg_recent(report_data)
#'
#' @importFrom dplyr %>%
#'
#' @export
#'

fivereg_recent <- function(x, n = 5) {
  # take the df slot and sort by published data
  # and then alphabetical order (they may tie on dates)
  out <- tryCatch(
    expr = {
  #####
  # make it easier to work with
  df <- x$df

  # we are suspicious, run checks
  stopifnot(is.data.frame(df))

  # correct variables?
  stopifnot(is.character(df$register))
  stopifnot(lubridate::is.POSIXct(df$date))

  # arrange from dplyr,
  # descending order for dates, ascending reg name
  # no longer need underscore with dplyr verbs used programmatically
  dplyr::arrange(df, desc(date), register) %>%
    dplyr::select(-phase) %>%
    tibble::as_tibble() -> sorted_list

  # take top n names
df_n <- head(sorted_list$register, n)

# make human readable list
output <- paste(df_n, collapse = ", ")
# make last comma "and"

return(output)

#####
    },
warning = function() {

  w <- warnings()
  warning('Warning produced running fivereg_recent():', w)

},
error = function(e)  {

  stop('Error produced running fivereg_recent():', e)

},
finally = {}
  )

}
# For testing and QA always use cmd+shift+ L
devtools::load_all(".")
rm(list = c("fivereg_recent"))
```

## Testing
Check a few things inside the function and be suspicious:

#e.g., by using 

stopifnot(is.character(df$register))

#check if it is a date:
stopifnot(lubridate::is.POSIXct(df$date))

## Template for Function and Test:  (DO NOT RUN)


# we are suspicious, run checks
# bare bones error handling
  # informative error handling
  out <- tryCatch(
    expr = {

# your function body goes here

    },
warning = function() {

  w <- warnings()
  warning('Warning produced running fivereg_recent():', w)

},
error = function(e)  {

  stop('Error produced running fivereg_recent():', e)

},
finally = {}
  )

# your functions closing }

## Error Handling
fivereg_recent(report_data)$date

# To check if there is errors:
report_data <- phase_date_data(regreg, log_level = futile.logger::ERROR)

# To see more information for quality assurance:
report_data <- phase_date_data(regreg, log_level = futile.logger::DEBUG)


# For testing and QA always use cmd+shift+ L
devtools::load_all(".")

fivereg_recent(df)$date

## .............................................. ##
## on Code editor:
git checkout -b feature/fivereg_recent
git status   
git add .  
git commit -m "feature/fivereg_recent Added fivereg_recent R code"
git push origin feature/fivereg_recent -u
git pull

## #is unit testing worth the effort?
https://stackoverflow.com/questions/67299/is-unit-testing-worth-the-effort?rq=1

# Install the released version from CRAN of testthat
# in RStduio type in console
# Or the development version from GitHub:
# install.packages("devtools")

#set up your package to use testthat
```{r}
usethis::use_testthat()
```

# USE this test examples:

https://github.com/DCMSstats/eesectors/blob/master/tests/testthat/test_year_sector_data.R

# testthat.R
```{r}
library(testthat)
library(dplyr)

#test_check("DataTidying")
```


## Test structure Template

A test file lives in tests/testthat/. Its name must start with test. Here‚Äôs an example of a test file from the stringr package:

context("String length")
library(stringr)

test_that("str_length is number of characters", {
  expect_equal(str_length("a"), 1)
  expect_equal(str_length("ab"), 2)
  expect_equal(str_length("abc"), 3)
})
#> Test passed ü•á

test_that("str_length of factor is length of level", {
  expect_equal(str_length(factor("a")), 1)
  expect_equal(str_length(factor("ab")), 2)
  expect_equal(str_length(factor("abc")), 3)
})
#> Test passed üéâ

test_that("str_length of missing is missing", {
  expect_equal(str_length(NA), NA_integer_)
  expect_equal(str_length(c(NA, 1)), c(NA, 1))
  expect_equal(str_length("NA"), 2)
})
#> Test passed üåà

#stringr

https://cran.r-project.org/web/packages/stringr/vignettes/stringr.html

# FROM testing hadley wickham
http://r-pkgs.had.co.nz/tests.html

## Unit Testing - Traditional:
Step1: write Logic (functions)
Step2: wite Tests (testthat)

# writing some tests in R
# test_fivereg_recent.R

```{r}
devtools::load_all(".")
devtools::document(roclets = c('rd', 'collate', 'namespace'))

context("fivereg_recent works as intended")

x <- DataTidying::phase_date_data(regreg)

mtcars_df_slot <- mtcars
mtcars_df_slot$df <- mtcars

# checked manually using Excel
manual_fivereg <- "allergen, statistical-geography-unitary-authority-eng,
                    statistical-geography-non-metropolitan-district-eng, 
                    statistical-geography-registration-district-wls, 
                    statistical-geography-registration-district-eng"

test_that(
  "fivereg_recent runs without errors",
  {
    expect_silent(fivereg_recent(x))
  }
)

#
#devtools::test()
#

test_that("fivereg_recent errors if input is not suitable dataframe", {
  expect_error(fivereg_recent(15))
  expect_error(fivereg_recent(mtcars_df_slot))

})

#
#devtools::test()
#


test_that("fivereg_recent equals manual sorting", {
  expect_equal(fivereg_recent(x), manual_fivereg)
})

test_that("fivereg_recent with n; correct number of commas", {
  expect_equal(stringr::str_count(fivereg_recent(x, 10),
                                  ','),  # we didn't fix the last comma being
               # an and
               9)

})

#
#devtools::test()
#


```


cmd + shift + t:

```{r}
#testthat::test_dir("/Users/leilayousefi/LeilaDocuments/git/MoJ/TidyData/DataTidying/tests/testthat/")

#testthat::test_check("DataTidying")

#devtools::test()

```

#tdd wikipedia
https://en.wikipedia.org/wiki/Test-driven_development

#what‚Äôs the difference between unit testing and ttd?
https://www.youtube.com/watch?v=QCif_-r8eK4

#code, from rap repo
https://github.com/mammykins/regregrap


## Test Driven Development:
Step1: write Tests (testthat)
Step2: write Logic (functions)

## Step1:
# test_figure_2.R
```{r}
context("figure_2 works as intended")

x <- phase_date_data(regreg)

test_that("figure_2 runs without errors", {
  expect_silent(figure_2(x))
})

test_that("figure_2 outputs a gg, ggplot class", {
  expect_equal(class(figure_2(x)), c("gg", "ggplot"))

})
# #   devtools::test()
```

## .............................................. ##

# code
```{r}
report_data <- DataTidying::phase_date_data(regreg)
  
  
  x$df$id <- as.numeric(row.names(x$df))
  
  x$df
  
  p <- ggplot2::ggplot(x$df, ggplot2::aes(x=date, y = rev(id))) +
        ggplot2::geom_line() +
        ggplot2::xlab("Date published") +
        ggplot2::ylab("Total register published")
#return(p)
p


# test
expect_equal(class(figure_2(x)), c("gg", "ggplot"))

```

Tests failed ==>
## Step2:
# figure_2.R
```{r}
#' @title Figure 2 of the regreg RAP report.
#'
#' @description The function returns the time series ggplot2 object geom_line.
#'
#' @param x Input object of \code{year_phase_data} class.
#'
#' @return Returns a ggplot object.
#'
#' @examples
#'
#' library(DataTidying)
#' report_data <- phase_date_data(regreg)
#' figure_2(report_data)
#'
#' @export
#'

figure_2 <- function(x) {

  x$df$id <- as.numeric(row.names(x$df))
  x$df

  p <- ggplot2::ggplot(x$df, ggplot2::aes(x = date, y = rev(id))) +
    ggplot2::geom_line() +
    ggplot2::xlab("Date published") +
    ggplot2::ylab("Total registers published")

  return(p)

}
devtools::load_all(".")
```

## .............................................. ##
## on Code editor:
git checkout -b feature/test
git status   
git add .  
git commit -m "feature/test Added fivereg_recent R code"
git push origin feature/test -u
git pull


## .............................................. ##
#visual tests for ggplot objectsr
https://github.com/lionel-/vdiffr

#visualTest
https://stackoverflow.com/questions/30246789/how-to-test-graphical-output-of-functions

#attempted move from visualTest to vdiffr for eesectors, build failure issue
#to do with FreeType issue described in the readme for vdiffr repo
# however, visualTest wasn‚Äôt failing when it should of been (detected with TDD)
https://github.com/DCMSstats/eesectors/commits/fix/47


## .............................................. ##


## Automated Testing:

The workflow for checking a package is simple, but tedious:

# 1. Run devtools::check(), or press Ctrl/Cmd + Shift + E:

```{r}
devtools::check()
```

# 2. Fix the first problem.

# 2.1 Create an issue in Github:
name of issue: 
Package check fails - Automated testing with R cmd check

# 2.2 read the errors:
e.g, package dependency ==> after reading DESCRIPTION file in R studio

# 2.3 search for the "DESCRIPTION" on: http://r-pkgs.had.co.nz/check.html and (cmd + F (DESCRIPTION))

# 2.4 OR writing r extension:
https://cran.r-project.org/doc/manuals/r-release/R-exts.html#The-DESCRIPTION-file   and  (cmd + F (DESCRIPTION))

# 2.5 OR in eesctors package in github

# 2.6 go find a reliable description file and copy it as appropriate

#2.6.1 on Depends section in the DESCRIPTION file add the dependent package e.g dplyr 

e.g. dplyr error so add "dplyr (>= 0.6.1)" to Depends in Description file

#Depends: R (>= 3.4.1), dplyr (>= 0.6.1)

#2.6.2 
Suggests: testthat
-> go to the packages and check the version of packages and add it
#Suggests: testthat(>= 1.0.2)

#2.6.3 
another warning about licence and go to eesectors and copy the licence to fix warning 
# License: GPL-3

Namespaces accessed by the ‚Äò::‚Äô and ‚Äò:::‚Äô operators must be listed here, or in ‚ÄòSuggests‚Äô or ‚ÄòEnhances‚Äô

#Imports: futile.logger (>= 1.4.3), ggplot2 (>=2.2.1), lubridate (), tibble (), zoo ()

# 2.7 Run devtools::check(), or press Ctrl/Cmd + Shift + E:

```{r}
devtools::check()
```

# find inspiration from other packages
# e.g. Description file
https://github.com/DCMSstats/eesectors

## ..................................... ##
# on Code editor:
git checkout -b feature/test
git status   
git add .  
git commit -m "feature/test Added fivereg_recent R code"
git push origin feature/test -u
git pull   

## ......................................... ##


Repeat until there are no more problems.

R CMD check returns three types of messages:

ERRORs: Severe problems that you should fix regardless of whether or not you‚Äôre submitting to CRAN.

WARNINGs: Likely problems that you must fix if you‚Äôre planning to submit to CRAN (and a good idea to look into even if you‚Äôre not).

NOTEs: Mild problems. If you are submitting to CRAN, you should strive to eliminate all NOTEs, even if they are false positives. If you have no NOTEs, human intervention is not required, and the package submission process will be easier. If it‚Äôs not possible to eliminate a NOTE, you‚Äôll need describe why it‚Äôs OK in your submission comments, as described in release notes. If you‚Äôre not submitting to CRAN, carefully read each NOTE, but don‚Äôt go out of your way to fix things that you don‚Äôt think are problems.



## ......................................... ##




## ......................................... ##
##   Continuous Integration (CI) with Travis

## checking after every commit with Travis 

CI check the command after every commit followed by push

# Badges and Tags in Github:

## install dependencies for MacOS

# Terminal ==>
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# ==> Next steps:
- Run brew help to get started
- Further documentation:
    https://docs.brew.sh
    
#brew update
#brew install travis

# install Xcode 13.3 Beta 2 Release Notes

Xcode 13.3 Beta 2 Release Notes




install.packages("remotes")
library(remotes)
install.packages("gitcreds")
library(gitcreds)

```{r}
install.packages("tidyverse") 
library(tidyverse)

devtools::check(remote = TRUE, manual = TRUE)

devtools::load_all(".")
devtools::document(roclets = c('rd', 'collate', 'namespace'))
devtools::install_deps(dependencies = TRUE)
check(force_suggests = FALSE)

#devtools::use_travis()
usethis::use_travis()
```

```{r message=TRUE, warning=TRUE, paged.print=TRUE}
usethis::use_travis()
```

## On code editor (visual studio code)
git log --oneline
git checkout -b feature/travis-ci
git status
git add .
...
git push feature/travis-ci -u
## The above cmd is followed in gitgub by a pull request and merge
...

## ##################
# sign up to travis
https://travis-ci.org/

#guide to travis
https://docs.travis-ci.com/user/getting-started/

# good blog on intro to travis
# how to get it to pass, common problems
https://juliasilge.com/blog/beginners-guide-to-travis/

# hadley wickham, bottom of the page
http://r-pkgs.had.co.nz/check.html

# Windows build test with appveyor
https://ci.appveyor.com/login

# eesectors example
https://github.com/DCMSstats/eesectors/blob/master/.travis.yml


## ......................................... ##
##  Extra Quality Assurrance

## On code editor (visual studio code)
git checkout -b feature/test_fail
git status
git add .
...
git push feature/test_fail -u
## The above cmd is followed in gitgub by a pull request and merge
...

## ##################
## On Github: Pull request
then all checks failed!
Thus, look at the problem 

#rap companion
https://ukgovdatascience.github.io/rap_companion/code-cover.html

#regregrap travis sticker
https://github.com/mammykins/regregrap

## ##################
## ##################
## Use Travis-CI with Codcov (Code Coverage)

#codecov
https://codecov.io/

# eesectors readme with codecov badges
https://github.com/DCMSstats/eesectors/blob/master/README.md   

## ......................................... ##



## ......................................... ##
##  Dependency Hell!


## ##################
# package dependencies in description 
http://r-pkgs.had.co.nz/description.html

# eesectors example
https://github.com/DCMSstats/eesectors/blob/master/DESCRIPTION
## ##################

# packrat
Set-up packrat for your package by following the guidance. Install packrat and then run it. 
CAVEAT: It will take a long time to run the first time, don't panic.

#packrat
https://rstudio.github.io/packrat/

https://rstudio.github.io/packrat/walkthrough.html
https://rstudio.github.io/packrat/commands.html
https://rstudio.github.io/packrat/rstudio.html
https://rstudio.github.io/packrat/limitations.html
https://rstudio.github.io/packrat/custom-repos.html

```{r}
install.packages("devtools")
devtools::install_github("rstudio/packrat")
```
# you should have something liek this in your repo
https://github.com/mammykins/regregrap/tree/master/packrat

## ......................................... ##
##    Error Logging

# when should one stop testing software?
It can relate quality assurance as a bayesian problem, as in when is the evidence sufficient that my code is bug free or suitably quality assured that I dont need to add any more tests then whether formal 


## ......................................... ##
##    vignette / Data product
It is useful for updationg data and we could simply reproduce the vignette and its data would be updated appropriately.


git checkout -b feature/vignette
## On code editor (visual studio code)
git log --oneline
git checkout -b feature/vignette
git status
git add .
...
git push feature/vignette -u

To create your first vignette, run:

```{r}
usethis::use_vignette("my-vignette")

install.packages("rmarkdown")
# install pandoc


```

This will:

Create a vignettes/ directory.

Add the necessary dependencies to DESCRIPTION (i.e. it adds knitr to the Suggests and VignetteBuilder fields).

Draft a vignette, vignettes/my-vignette.Rmd.

The draft vignette has been designed to remind you of the important parts of an R Markdown file. It serves as a useful reference when you‚Äôre creating a new vignette.

Once you have this file, the workflow is straightforward:

Modify the vignette.

Press Ctrl/Cmd + Shift + K (or click ) to knit the vignette and preview the output.
There are three important components to an R Markdown vignette:

The initial metadata block.
Markdown for formatting text.
Knitr for intermingling text, code and results.
These are described in the following sections.


```{r}

```

# rap companion with links
https://ukgovdatascience.github.io/rap_companion/pub.html

# hadley wickham vignettes
http://r-pkgs.had.co.nz/vignettes.html

# prettify plots - gov format
https://cran.r-project.org/web/packages/ggthemes/index.html

# practice makes perfect, here‚Äôs a toy example which is useful if your new to RMarkdown
https://github.com/moj-analytical-services/rmarkdown_training

#see github repo
https://github.com/ukgovdatascience/govstyle


Follow Hadley Wickham's workflow to create a vignette with a suitable name. Create a minimal viable report and iterate as appropriate.

Consider using other ready-made style templates or create your own custom css (ask around, your organisation probably already has one!).

Questions for this assignment
Have you produced your desired data product?

How proud do you feel right now?

# css style sheet, what is it?
https://www.w3schools.com/html/html_css.asp

# some nice templates
https://blog.rstudio.com/2016/03/21/r-markdown-custom-formats/

# ggplot themes
https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html

# advanced customisation
https://rmarkdown.rstudio.com/html_document_format.html#advanced_customization

# custom css
https://rmarkdown.rstudio.com/html_document_format.html#custom_css
## ......................................... ##

https://bookdown.org/yihui/rmarkdown/html-document.html#advanced_customization



https://github.com/mammykins/regregrap

# look at some of Hadley‚Äôs tests here (or use a package you are familiar with)
https://github.com/tidyverse/stringr/tree/master/tests/testthat

# review the rap companion
https://ukgovdatascience.github.io/rap_companion/

#anything you want to add from your RAP battle experience?
https://github.com/ukgovdatascience/rap_companion
## ......................................... ##

## Ensuring Quakity inputs 

# using the futile.logger package
This allowed us to modify the checks output to the console based on the expertise and interest of the user. For example, a statistician might just want to know if it passed or failed, whereas the package maintainer might like to see all checks.

For example in the eesectors package compare the output when running:

```{r}
library(eesectors)
 
GVA <- year_sector_data(GVA_by_sector_2016,
                     log_level = futile.logger::WARN)
 
GVA <- year_sector_data(GVA_by_sector_2016,
                     log_level = futile.logger::TRACE)
```

This demonstrates a hierarchy of conditions, checks and messages that can be relayed to the user.

This is an advanced topic, see here for the detail that inspired us.

At the minimum use tryCatch() to catch problems in your code as demonstrated here. Add this to your function ensuring to change the warning and error messages on lines 71 and 76.

# Lecture quality assurrance through defensive programming will provide you with a refresher on how to do the basics.

## ......................................... ##
Questions for this assignment
Have you wrapped your function in tryCatch()? If not have you used the futile.logger package for condition handling?

We opted for futile.logger  for initiating the class and checking the data, we use tryCatch  for the other functions. futile.logger  has a good tutorial on the README.

## Github -> realease -> new realease -> name: 1.0.0
## ......................................... ##
##   Versioning   ##


$ git tag -a v1.4 -m "my version 1.4"
$ git tag

# Semantic Versioning
https://semver.org/

# add tags in git
https://git-scm.com/book/en/v2/Git-Basics-Tagging

# versions are based on git tags
https://help.github.com/articles/creating-releases/

## ......................................... ##

##    Docker for reproducibility   ##
Based on feedback I added a lecture on using Docker to ensure a reproducible computing environment for the production of your data product. This appears in Section 9 on Producing your report and includes an additional assignment. By the end of it you will have Docker installed and used a rocker container to produce your data product.
# Download and install Docker and start with hello world program:

https://medium.com/crowdbotics/a-complete-one-by-one-guide-to-install-docker-on-your-mac-os-using-homebrew-e818eb4cfc3



# Docker
https://www.docker.com/what-docker

# get docker
https://www.docker.com/community-edition
# or use brew
# in terminal
# brew install --cask docker 
# docker --version
$ brew install docker docker-machine
$ brew cask install virtualbox
-> need password
-> possibly need to address System Preference setting
$ docker-machine create --driver virtualbox default
$ docker-machine env default
$ eval "$(docker-machine env default)"
$ docker run hello-world
$ docker-machine stop default
# in your terminal execute the following uncommented code
# once installed pull an image
docker pull hello-world

# create container to run hello-world
# read the output for details
docker run hello-world

# docker run hello world
# docker run rucker/verse:3.5.0
# docker run -d -p 8787:8787 rocker/verse:3.5.0

## ......................................... ##
##   rockerverse

Data:Code:Environment

To reproduce the computing environment
# Rocker for docker
https://hub.docker.com/r/rocker/
# rocker paper
https://arxiv.org/abs/1710.03675

#start docker, may take a while first time, specify a version to fix the computing environment in time
# if you dont, it will run the latest docekr image

docker run -d -p 8787:8787 rocker/verse

browser  (http://localhost:8787)

## In the browser in console of rstadio type in the following:

# devtools::install_github("klutometis/roxygen")
# devtools::install_github(c("rstudio/httpuv", "rstudio/shiny"))
# devtools::install_github("hadley/httr@v0.4")
# devtools::install_github("mammykins/regregrap@v1.0.0")

# devtools::install_github("Leilayousefi/DataTidying@v1.0.0")

```{r setup}
knitr::opts_chunk$set(warning = TRUE, message = TRUE)
devtools::install_github("klutometis/roxygen")
devtools::install_github(c("rstudio/httpuv", "rstudio/shiny"))
devtools::install_github("hadley/httr@v0.4")
devtools::install_github("mammykins/regregrap")
devtools::install_github("Leilayousefi/DataTidying")
install.packages("rmarkdown")
# install pandoc
library(DataTidying)
#library(klutometis/roxygen)
library(httr)
library(regregrap)
library(httpuv)
library(shiny)
library(rmarkdown)
```


## Copy Vignette Rmd content and paste into the Rstadio new document rmarkdown (in the browser  (http://localhost:8787))

# knit (cmd+shift+k)

# A dockerfile example from eesectors package
https://github.com/DCMSstats/eesectorsdocker

# liftr approach might be useful
https://cran.r-project.org/web/packages/liftr/vignettes/liftr-intro.html
## ......................................... ##







## ......................................... ##
## ......................................... ##


https://rdrr.io/github/DCMSstats/eegva/src/R/extract_sic91.R

https://ukgovdatascience.github.io/rap_companion/

https://www.udemy.com/reproducible-analytical-pipelines/

# some free data science courses, with basic R programming included
https://medium.freecodecamp.org/the-best-data-science-courses-on-the-internet-ranked-by-your-reviews-6dc5b910ea40

# some programming 
https://medium.freecodecamp.org/if-you-want-to-learn-data-science-start-with-one-of-these-programming-classes-fb694ffe780c

# you can use swirl to teach and swirlify to assess learners
http://swirlstats.com/

# RAP is probably a bad name as the emphasis should be on sustainability rather than reproducibility
https://software.ac.uk/blog/2018-05-21-why-government-needs-sustainable-software-too

https://www.statisticsauthority.gov.uk/a-robot-by-any-name/

## ......................................... ##




## ......................................... ##
##  Error Logging



## ##################
## making untidy data tidy
reorganize the values in your data set with the the spread() and gather() functions of the tidyr package.

```{r}
library(DSR)
# Data set one
table1

# Data set two
table2

# Data set three
table3

# Data set four
table4  # cases

table5  # population


```

```{r}
mean(table1$cases)
table1$cases / table1$population * 10000
```

Each variable in the data set is placed in its own column
Each observation is placed in its own row
Each value is placed in its own cell*

## split apart and combine values in your data set to make them easier to access with R

```{r}

library(tidyr)
spread(table2, key, value)
```

## R factors
R uses factors to handle categorical variables, variables that have a fixed and known set of possible values. Factors are also helpful for reordering character vectors to improve display. The goal of the forcats package is to provide a suite of tools that solve common problems with factors, including changing the order of levels or the values. Some examples include:

fct_reorder(): Reordering a factor by another variable.
fct_infreq(): Reordering a factor by the frequency of values.
fct_relevel(): Changing the order of a factor by hand.
fct_lump(): Collapsing the least/most frequent values of a factor into ‚Äúother‚Äù.
You can learn more about each of these in vignette("forcats"). If you‚Äôre new to factors, the best place to start is the chapter on factors in R for Data Science.

```{r}
library(forcats)
library(dplyr)
library(ggplot2)

print(starwars)

starwars %>% 
  filter(!is.na(species)) %>%
  count(species, sort = TRUE)

starwars %>%
  filter(!is.na(species)) %>%
  mutate(species = fct_lump(species, n = 3)) %>%
  count(species)

ggplot(starwars, aes(x = eye_color)) + 
  geom_bar() + 
  coord_flip()

starwars %>%
  mutate(eye_color = fct_infreq(eye_color)) %>%
  ggplot(aes(x = eye_color)) + 
  geom_bar() + 
  coord_flip()
```


## combining everything you‚Äôve learned about tidyr to tidy a real data set on tuberculosis epidemiology collected by the World Health Organization.
